name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: '0 0 * * 1'

permissions:
  contents: read

jobs:
  security-scan:
    name: Security Vulnerability Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86 # v5

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]"

      - name: Run pip-audit (PyPA Official)
        run: |
          uv pip install --system pip-audit
          # Generate JSON report for artifact
          pip-audit --desc --format json --output pip-audit-report.json || true
          # Run with human-readable output and fail on vulnerabilities
          echo "Running pip-audit with vulnerability detection..."
          pip-audit --desc --strict || {
            echo "::warning::pip-audit found vulnerabilities in dependencies"
            exit 1
          }

      - name: Run Ruff Security Rules
        run: |
          ruff check --select S --output-format json src/juxlib/ > ruff-security-report.json || true
          ruff check --select S src/juxlib/
        continue-on-error: true

      - name: Upload pip-audit report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: pip-audit-report
          path: pip-audit-report.json

      - name: Upload Ruff Security report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: ruff-security-report
          path: ruff-security-report.json

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4
        with:
          fail-on-severity: moderate

  trivy-scan:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy vulnerability scanner (Table)
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Upload Trivy results as artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: trivy-results
          path: trivy-results.sarif

  sbom-validation:
    name: SBOM Validation & Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86 # v5

      - name: Install cyclonedx-bom
        run: |
          uv pip install --system cyclonedx-bom

      - name: Generate SBOM
        run: |
          cyclonedx-py requirements /dev/null \
            --pyproject pyproject.toml \
            --of JSON \
            --output-file py-juxlib-sbom.cdx.json

          echo "Generated SBOM:"
          ls -lh py-juxlib-sbom.cdx.json

      - name: Validate SBOM
        continue-on-error: true
        run: |
          # Basic JSON validation
          python -c "import json; json.load(open('py-juxlib-sbom.cdx.json'))"
          echo "SBOM JSON structure valid"

      - name: Analyze SBOM
        run: |
          echo "SBOM Analysis:"
          echo "Component count:"
          cat py-juxlib-sbom.cdx.json | \
            python -c "import sys, json; data=json.load(sys.stdin); print(f'Total components: {len(data.get(\"components\", []))}')"

      - name: Audit dependencies from SBOM
        run: |
          uv pip install --system pip-audit
          pip-audit --desc --strict

      - name: Upload SBOM artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: sbom
          path: py-juxlib-sbom.cdx.json

  security-tests:
    name: Security Test Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86 # v5

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]"

      - name: Run security tests
        run: |
          if [ -d "tests/security" ]; then
            pytest tests/security/ -v --tb=short --no-cov
          else
            echo "No security tests found - skipping"
          fi

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: security-test-coverage
          path: htmlcov/

  scorecard:
    name: OpenSSF Scorecard
    runs-on: ubuntu-latest
    if: github.event.repository.private == false
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Run OpenSSF Scorecard
        uses: ossf/scorecard-action@62b2cac7ed8198b15735ed49ab1e5cf35480ba46 # v2.4.0
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          publish_results: true

      - name: Upload Scorecard results to GitHub Security
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3
        with:
          sarif_file: scorecard-results.sarif

      - name: Upload Scorecard results artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: scorecard-results
          path: scorecard-results.sarif
